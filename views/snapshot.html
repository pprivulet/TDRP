{% extends 'layout.html' %}



{% block content %}
 <div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
    <div class="row">
        <h4 class="sub-header"><strong>路况实时快照</strong></h4>       
        <div class="" role="alert"><span class="small"><img style="vertical-align:middle;" src="/image/snapshot.png">点击查看路况快照</span></div>
    </div>    
          
    <div class="row"> 
        <div class="well" style="margin-top:5px;height:790px;">
            <div id="i-map" style="width: 100%; height:100%"></div>
        </div>    
    </div>
	
    
   
</div>
{% endblock %}

{% block map %}
    <script type="text/javascript">      
  
        var map = new BMap.Map("i-map");      //设置卫星图为底图
        var point = new BMap.Point(120.645,31.144);
        map.centerAndZoom(point,14);//设定地图的中心点和坐标并将地图显示在地图容器中
        map.addControl(new BMap.NavigationControl());      //为地图添加鱼骨  
        map.enableScrollWheelZoom();//启用地图滚轮放大缩
        var img = "/image/t2.png";
        var h = 30;
        var w = 30;
        //var point = null;	    
	    //var myIcon = null;
	    //var marker = null;  // 创建标注
        //var infoWindow = null;  // 创建信息窗口对象
        //var points = [];
        
        
        
        
        $.get("/_gpsNO", function(data,status){
            if(status==="success"){
              var no = data.no;
              console.log(no);
              
              for(var i=1;i<=no;i++){
                $.post("/_gps",{id:i},function(data, status){                    
                    var sContent =        
                      "<div class='alert alert-warning'>" +        
                      "<h4><span class='label label-default'> 快照 </span></h4><hr/>"+
                      "<h5>地点：<label id='location'>"+
                      data.gps.name+
                      "</label></h5>"+
                      "<h5>时间:<label id='time'>"+
                      new Date()+
                      "</label></h5>"+ 
                      "<img  id='imgDemo' height=220 widht=220 src='/image/crack.png'/>" + 
                      "</div>"
                    var point = new BMap.Point(data.gps.longitude, data.gps.latitude);	    
                    var myIcon = new BMap.Icon(img, new BMap.Size(h,w));
                    var marker = new BMap.Marker(point,{icon:myIcon});  // 创建标注
                    var infoWindow = new BMap.InfoWindow(sContent);  // 创建信息窗口对象
                    map.addOverlay(marker);
                    marker.addEventListener("click", function(){       
                      this.openInfoWindow(infoWindow);
                      //d = new Date();        
                      //$('#time').html(d);
                      $('#imgDemo').attr('src','/image/crack.png?'+d.getTime());
                        document.getElementById('imgDemo').onload = function (){                
		                infoWindow.redraw();   //防止在网速较慢，图片未加载时，生成的信息框高度比图片的总高度小，导致图片部分被隐藏
                      }
                    });
                });
              
              
              }
              
              
              
              
            } else {}
        });
       
            
     
        
        
        
        
	    
	    
        
    </script> 
{% endblock %}
